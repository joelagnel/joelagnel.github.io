
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Understanding Critical Section Behavior With Ftrace Output - LinuxInternals.org</title>
  <meta name="author" content="Joel Fernandes">

  
  <meta name="description" content="The ftrace irqsoff, preempt and preemptirqsoff tracers are amazing tools identify paths in Linux kernel code that block tasks from getting CPU-time. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.linuxinternals.org/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="LinuxInternals.org" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-50777115-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><div>
<div style="margin-right:50px;float:left;">
  <h1><a href="/">LinuxInternals.org</a></h1>
  
    <h2>by Joel Fernandes</h2>
  
</div>
<div style="float:left;" class="hnav">
 <a href="/joel">About me</a><br>
 <a href="/blog/archives/">Articles</a><br>
 <a href="/resources">Talks and resources</a><br>
</div>
<div style="float:right;">
<img src="/images/peng.png" height=150 width=150>
</div>

<div style="position:absolute; top: 170px" class="hnavtitle">
<a>Bits about inner workings of Linux</a>
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
<!-- a href="http://www.meetup.com/LinuxInternals-org-Embedded-Linux-Training/">Join the internals meetup! -->
</div>
</div>

</header>
<!--
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.linuxinternals.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/technical-resources/">Resources</a></li>
  <li><a href="/aboutme/">About me</a></li>
</ul>

</nav>
-->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Understanding Critical Section Behavior With Ftrace Output</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-03-12T11:08:38-08:00" pubdate data-updated="true">Mar 12<span>th</span>, 2016</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://www.linuxinternals.org">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>The ftrace irqsoff, preempt and preemptirqsoff tracers are amazing tools identify paths in Linux kernel code that block tasks from getting CPU-time. Essentially during these paths, the scheduler has its hands tied behind its back. There are mainly 2 cases where this can happen.</p>

<p>Local Interrupts disabled (masked):
All CPU cores have a bit in a &lsquo;flags&rsquo; or status register, that is used to mask interrupts on that particular CPU. For x86 architectures, its in a <a href="https://en.wikipedia.org/wiki/FLAGS_register">FLAGS register</a> called the <a href="https://en.wikipedia.org/wiki/Interrupt_flag">IF bit</a>. With this bit set, timer interrupts wont be received without which the scheduler wont get a chance to run and schedule something else.</p>

<p>Preemption disabled:
Preemption is often disabled in the kernel when acquiring spinlocks. We went over the mechanics of spinlocks <a href="http://www.linuxinternals.org/blog/2014/05/07/spinlock-implementation-in-linux-kernel/">previously</a>. There are other cases where preepmtion may be disabled as well. With preemption turned off, the scheduler will not preempt an existing task and prevent giving some other task a chance to run.</p>

<p>Both these cases introduce latency to runnable tasks and so they are bad for predictablity and real-timeness. Disabling interrupts is worse than turning off preemption because this also has the added effect of introducing latency to other interrupts.</p>

<p>The tracers I just mentioned are called latency tracers and they trace the total latency and optionally the functions that are executed between when irqs are turned off and on, or when preempt is turned off and on. They are <a href="https://www.kernel.org/doc/Documentation/trace/ftrace.txt">documented well</a> so I wont go over them here.</p>

<p>One thing I want to mention is about the preemptirqsoff tracer, it starts when when <em>either</em> preempt <em>or</em> irqs are turned off, and stops tracing only when <em>both</em> preemption and irqs are turned back on.
This makes the preemptirqsoff tracer excellent in tracing kernel code paths that are blocking a task because regardless of whether preemption or irqs causing the latency, it treats both these cases identical or interchangeable. Borrowing from the amazing documentation, the following example illustrates this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Knowing the locations that have interrupts disabled or
</span><span class='line'>preemption disabled for the longest times is helpful. But
</span><span class='line'>sometimes we would like to know when either preemption and/or
</span><span class='line'>interrupts are disabled.
</span><span class='line'>
</span><span class='line'>Consider the following code:
</span><span class='line'>
</span><span class='line'>    local_irq_disable();
</span><span class='line'>    call_function_with_irqs_off();
</span><span class='line'>    preempt_disable();
</span><span class='line'>    call_function_with_irqs_and_preemption_off();
</span><span class='line'>    local_irq_enable();
</span><span class='line'>    call_function_with_preemption_off();
</span><span class='line'>    preempt_enable();
</span><span class='line'>
</span><span class='line'>The irqsoff tracer will record the total length of
</span><span class='line'>call_function_with_irqs_off() and
</span><span class='line'>call_function_with_irqs_and_preemption_off().
</span><span class='line'>
</span><span class='line'>The preemptoff tracer will record the total length of
</span><span class='line'>call_function_with_irqs_and_preemption_off() and
</span><span class='line'>call_function_with_preemption_off().
</span><span class='line'>
</span><span class='line'>But neither will trace the time that interrupts and/or
</span><span class='line'>preemption is disabled. This total time is the time that we can
</span><span class='line'>not schedule. To record this time, use the preemptirqsoff
</span><span class='line'>tracer.</span></code></pre></td></tr></table></div></figure>


<p>It appears though that function tracing in preempt tracers is a bit broken and I <a href="https://lkml.org/lkml/2016/3/12/24">posted a fix</a> for a bug which prevent tracing functions which were called while interrupts were enabled and preemption is disabled. So in the above example, call_function_with_preemption_off wouldn&rsquo;t be traced. It still tracks the max latency and reports it, but it would omit the tracing of this function.</p>

<p>Coming back to the original topic of understanding critical section kernel behavior, the beautiful ftrace output for latency tracers show you a set of flags on the left beside every function traced which illustrates what is going on with preemption and interrupts in the traced function. Here I will go over a set of trace outputs and show you some interesting things.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joel Fernandes</span></span>

      








  


<time datetime="2016-03-12T11:08:38-08:00" pubdate data-updated="true">Mar 12<span>th</span>, 2016</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.linuxinternals.org/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output/" data-via="" data-counturl="http://www.linuxinternals.org/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/25/tying-2-voltage-sources-slash-signals-together/" title="Previous Post: Tying 2 voltage sources/signals together">&laquo; Tying 2 voltage sources/signals together</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/20/tif-need-resched-why-is-it-needed/" title="Next Post: TIF_NEED_RESCHED: why is it needed">TIF_NEED_RESCHED: why is it needed &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/02/10/usdt-notes/">USDT for Reliable Userspace Event Tracing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/08/bpfd-bcc/">BPFd- Running BCC Tools Remotely Across Systems and Architectures</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/31/nmi-perf-armv8/">ARMv8: Flamegraph and NMI Support</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/18/ftrace-events-mechanism/">Ftrace Events Mechanism</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/20/tif-need-resched-why-is-it-needed/">TIF_NEED_RESCHED: Why Is It Needed</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output/">Understanding Critical Section Behavior With Ftrace Output</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/25/tying-2-voltage-sources-slash-signals-together/">Tying 2 Voltage Sources/signals Together</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/04/a-microsd-card-remote-switcher/">MicroSD Card Remote Switch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/07/spinlock-implementation-in-linux-kernel/">Linux Spinlock Internals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/24/studying-cache-line-sharing-effects-on-smp-systems/">Studying Cache-line Sharing Effects on SMP Systems</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/22/design-of-fork-followed-by-exec-in-linux/">Design of Fork Followed by Exec in Linux</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Joel Fernandes -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'linuxinternals1';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.linuxinternals.org/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output/';
        var disqus_url = 'http://www.linuxinternals.org/blog/2016/03/12/understanding-critical-section-behavior-with-ftrace-output/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
